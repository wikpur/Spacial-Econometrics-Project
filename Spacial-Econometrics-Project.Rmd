---
title: ""
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    self_contained: true
    default_style: "light"
    downcute_theme: "default"
---

```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(cache = TRUE)
```


# *Spatial Trends in Property Crimes: A Focus on crimes against property across Poland's  Pomeranian voivodeship*

## INTRODUCTION

The study aims to analyze spatial trends in property crimes, in Poland in regards to the Pomeranian voivodeship and itâ€™s counties. Further examination explores how socio-economic factors---like unemployment rate, social services, average gross monthly salary, population density and international migrations --- affect crime rates, considering geographic contexts. The study takes data from 2018.

## I. DATA DESCRIPTION

The database comprises data on the number of ascertained crimes in 2018 across Poland's Pomeranian voivodeship and it's counties.

**Crime ascertained** is a crime concluded with confirmation of the occurrence of the prohibited act.

The database contain only the crimes committed by an adult.

[Note:]{.underline} Polish law indicates that theft with a value not exceeding 500 PLN is considered a misdemeanor, not a crime. Reporting such theft will not be considered or processed, so there is no point in reporting them. Such a situation causes a disturbance between the actual amount of thefts and the recorded ones, since people has no incentive to report a theft under 500 PLN. This aspect was taken into consideration during the examination.

## II. DATA VISUALIZATION

```{r}
install.packages(sf)
install.packages(rgugik)
install.packages(bdl)
install.packages(elevatr)
install.packages(terra)
install.packages("ggplot2")
install.packages("tidyverse")
install.packages("giscoR")
install.packages("mapsf")
install.packages("spatialreg")
install.packages("hglm")
install.packages("mgcv")
install.packages("tmap")
install.packages("lmtest")
install.packages("zoo")
install.packages("plot.matrix")
install.packages("viridis")
```

```{r}
Sys.setenv("PROJ_NETWORK"="ON")
library(rgugik)
library(sf)
library(bdl)
library(giscoR)
library(mapsf)
library(sp)
library(spdep)
library(spatialreg)
library(hglm)
library(mgcv)
library(tmap)
library(lmtest)
library(zoo)
library(plot.matrix)
library(viridis)
```
### CREATING THE DATABASE 

```{r}
substring(county_names$TERYT, 1, 2) -> vopom
county_names |> subset(subset = vopom == "22") -> pom01
```

```{r}
borders_get(TERYT = pom01$TERYT) -> wpom
ID <- as.integer("0012345") 
str(ID)
formatC(ID, format="d", width=7, flag="0")
dim(wpom)
wpom |> sapply(class) |> str()
str(wpom$TERYT)
str(pom01)
```

```{r}
any(is.na(match(wpom$TERYT, pom01$TERYT)))
```

```{r}
wpom |> merge(pom01, by = "TERYT") -> wpom1 
wpom1
```

```{r}
all <- readxl::read_excel("all_variables.xlsx")
sapply(all, class)
names(all)
wpom1 |> merge(all, by.x = "TERYT",
 by.y = "Code") -> wpom2
wpom2
```

```{r}
wpom2 |> st_area() |>
 units::set_units("km2") -> wpom2$area_km2
wpom2 |> st_drop_geometry() |>
 subset(select = c(poplation, area_km2)) |>
 apply(1, function(x) x[1]/x[2]) -> wpom2$density
 wpom2
```

```{r}
wpom2 |> st_drop_geometry() |>
 subset(select = c(crimes, poplation)) |>
 apply(1, function(x) x[1]/x[2]) -> wpom2$ratecrimes
 wpom2
```


### UNEMPLOYMENT RATE

We assume that there is direct proportional relationship between unemployment rate and crimes against propertyt (the higher rate of unemployment, the higher amount of crimes against property).```

```{r}
library(mapview)
mapview(wpom2, zcol="unemp")
```

```{r}
pom_gisco <- gisco_get_nuts(year="2021", resolution="01",
 spatialtype="RG", nuts_id="PL63")
pom_gisco_tm <- st_transform(pom_gisco, "EPSG:2180")
wpom3 <- st_intersection(wpom2, pom_gisco_tm)
```

```{r}
wpom2 |> st_geometry_type() |> table() -> tab5; tab5[tab5>0]
```


```{r}
wpom3 |> st_geometry_type() |> table() -> tab6; tab6[tab6>0]
```


```{r}
wpom3 |> st_cast("MULTIPOLYGON") -> pom3
```

```{r}
mapview(wpom3, zcol="unemp")
```

```{r}
plot(density(wpom3$unemp))
```

```{r}
mapsf::mf_map(wpom3, var="unemp", type="choro", breaks="geom",
 nbreaks=7)
```

### SOCIAL SERVICES USERS

A direct proportional relationship between social services users and crimes against property is assumed (the higher rate of social services users, the higher amount of crimes against property).

```{r}
mapview(wpom3, zcol="ssusers")
```

```{r}
plot(density(wpom3$ssusers))
```

```{r}
mapsf::mf_map(wpom3, var="ssusers", type="choro", breaks="geom",
 nbreaks=7)
```

### AVERAGE GROSS MONTHLY SALARY 

An inverse relationship between average gross monthly salary and crimes against property is assumed (the higher amount of average gross monthly salary, the lower amount of crimes against property).

```{r}
mapview(wpom3, zcol="avgsal")
```

```{r}
plot(density(wpom3$avgsal))
```

```{r}
mapsf::mf_map(wpom3, var="avgsal", type="choro", breaks="geom",
              nbreaks=7)
```

### POPULATION DENSITY 

It is assumed that the number of crimes committed is directly proportional to the population density of cities, meaning we expect a greater number of thefts in larger urban areas.

```{r}
mapview(wpom3, zcol="density")
```

```{r}
plot(density(wpom3$density))
```

```{r}
mapsf::mf_map(wpom3, var="density", type="choro", breaks="geom",
              nbreaks=7)
```

### CRIMES

```{r}
mapview(wpom3, zcol="ratecrimes")
```

```{r}
plot(density(wpom3$ratecrimes))
```

```{r}
mapsf::mf_map(wpom3, var="ratecrimes", type="choro", breaks="geom",
 nbreaks=7)
```

```{r}
(wpom3 |> poly2nb(queen=FALSE,
 row.names=wpom3$TERYT) -> pom_rook_nb)
```

```{r}
(wpom3 |> poly2nb(queen=TRUE,
 row.names=wpom3$TERYT) -> pom_queen_nb)
```

```{r}
(wpom3 |> poly2nb(queen=FALSE, row.names=wpom3$TERYT,
 snap=0.00001) -> pom_rook_nb)
(wpom3 |> poly2nb(queen=TRUE, row.names=wpom3$TERYT,
 snap=0.00001) -> pom_queen_nb)
```

```{r}
geom <- st_geometry(wpom2) 
plot(geom, border="grey")
plot(pom_queen_nb, geom, add=TRUE)
```
```{r}
(geom |> st_point_on_surface() |> knearneigh(k=5) |>
 knn2nb(row.names=wpom2$TERYT) -> pom_1_nb)
```

```{r}
plot(geom, border="grey")
plot(pom_1_nb, geom, add=TRUE)
```

```{r}
pom_queen_nb |> nb2listw(style="W") -> pom_queen_lw
summary(pom_queen_lw)
```

```{r}
pom_queen_lw$weights |> sapply(sum) |> unique()
```

## TEST OF SPACIAL AUTOCORRELATION


```{r}

lw <- nb2listw(pom_queen_nb, style = "W")

moran_test <- moran.test(wpom3$ratecrimes, listw = lw, randomisation = TRUE, alternative = "two.sided")
print(moran_test)

```
The Moran's I test was conducted to examine whether there is spatial autocorrelation in property crimes across Poland's Pomeranian voivodeship. 
(Spatial autocorrelation refers to the tendency of similar values to cluster together in space.)

Since the p-value (0.2962) is greater than the conventional significance level of 0.05, we fail to reject the null hypothesis. This suggests that there is insufficient evidence to conclude that there is significant spatial autocorrelation in the variable crimes across the region.


###TEST OF RESIDUAL SPATIAL AUTOCORRELATION

```{r}

lm_null <- lm(ratecrimes ~ 1, data = wpom3)

moran_test <- moran.test(residuals(lm_null), listw = lw, randomisation = FALSE, alternative = "two.sided")

print(moran_test)

```
The Moran's I test conducted on the residuals of the linear regression model indicates no significant spatial autocorrelation (p = 0.4692). Thus, there is no evidence to suggest that neighboring regions exhibit similar crime rates beyond what would be expected by chance.

```{r}
lm.morantest(lm_null, listw=lw, alternative="two.sided")
```

```{r}
form_pre <- ratecrimes ~ log(density) + avgsal +
 unemp + ssusers
lm_obj_pre <- lm(form_pre, data= wpom3)
moran.test(residuals(lm_obj_pre), listw=lw,
 randomisation=FALSE, alternative="two.sided")
```
```{r}
lm.morantest(lm_obj_pre, listw=lw, alternative="two.sided")
```
```{r}
lm.morantest.sad(lm_obj_pre, listw=lw, alternative="two.sided")
```

```{r}
lm.morantest.exact(lm_obj_pre, listw=lw, alternative="two.sided")
```
## RAO'S SCORE

```{r}
summary(lm.RStests(lm_obj_pre, listw=lw, test="all"))
```
```{r}
summary(SD.RStests(lm_obj_pre, listw=lw, test="SDM"))
```
```{r}
summary(SD.RStests(lm_obj_pre, listw=lw, test="SDEM"))
```
```{r}
SLX_obj <- lmSLX(form_pre, data=wpom3, listw=lw)
summary(lm.RStests(SLX_obj, listw=lw, test="all"))
```

```{r}
form_post <- update(form_pre, log(realNetPst) ~ . - log(realWgPre) + log(realWgPst))
```


## CAR AND SAR

```{r}
library(spdep)
lwB <- nb2listw(pom_queen_nb, style="B")
library(spatialreg)
car1 <- spautolm(form_pre, data=wpom3, listw=lwB, family="CAR")
summary(car1, Nagelkerke=TRUE)
```

```{r}
wpom3$ranef_ml <- car1$fit$signal_stochastic
```

```{r}
w <- as(lwB, "CsparseMatrix")
car2 <- hglm(fixed=form_pre, random= ~ 1|TERYT, data=wpom3, family = gaussian(), rand.family=CAR(D = w))
car2
```

```{r}
wpom3$ranef_hglm <- c(unname(car2$ranef))
```

```{r}
names(pom_queen_nb) <- attr(pom_queen_nb, "region.id")
wpom3$TERYT <- factor(wpom3$TERYT)
car3 <- gam(update(form_pre, . ~ . + s(TERYT, bs="mrf", xt=list(nb=pom_queen_nb))), data=wpom3)
summary(car3)
```
```{r}
wpom3$ranef_mrf <- unname(predict(car3, type="terms")[, "s(TERYT)"])
```

```{r}
cbind(ML=coef(car1)[1:5], HGLM=car2$fixef[1:5], MRF=coef(car3)[1:5])
```
```{r}
cor(st_drop_geometry(wpom3)[, c("ranef_ml", "ranef_hglm", "ranef_mrf")])
```
```{r}
tm_shape(wpom3) + tm_fill(c("ranef_ml", "ranef_hglm", "ranef_mrf"), title="random effect", n=9, midpoint=0, style="fisher") + tm_borders() + tm_facets(free.scales=FALSE) + tm_layout(panel.labels=c("ML", "HGLM", "MRF"))
```
##SIMULTANEOUS AUTOREGRESSIVE MODELS

```{r}
sar1B <- spautolm(form_pre, data=wpom3, listw=lwB, family="SAR")
summary(sar1B, Nagelkerke=TRUE)
```
```{r}
1/range(eigenw(lwB))
```
```{r}
lw <- nb2listw(pom_queen_nb, style="W")
e <- eigenw(lw)
1/range(e)
```
```{r}
sar1 <- spautolm(form_pre, data=wpom3, listw=lw, family="SAR", control=list(pre_eig=e))
summary(sar1, Nagelkerke=TRUE)
```
```{r}
SEM_pre <- errorsarlm(form_pre, data=wpom3, listw=lw, control=list(pre_eig=e))
summary(SEM_pre, Nagelkerke=TRUE)
```

```{r}
all.equal(coef(SEM_pre)[c(2:6, 1)], coef(sar1), tol=2e-07)
```

```{r}
Hausman.test(SEM_pre)
```
```{r}
GNM_pre <- sacsarlm(form_pre, data=wpom3, listw=lw,control=list(pre_eig1=e, pre_eig2=e))
SAC_pre <- sacsarlm(form_pre, data=wpom3, listw=lw, control=list(pre_eig1=e, pre_eig2=e))
```

```{r}
lrtest(GNM_pre, SAC_pre)
```
```{r}
SDEM_pre <- errorsarlm(form_pre, data=wpom3, listw=lw, control=list(pre_eig=e))
Hausman.test(SDEM_pre)
```
```{r}
SDM_pre <- lagsarlm(form_pre, data=wpom3, listw=lw, control=list(pre_eig=e))
```

```{r}
c(LM_test=signif(SDM_pre$LMtest), p.value=format.pval((1 - pchisq(SDM_pre$LMtest, 1))))
```
```{r}
SLM_pre <- lagsarlm(form_pre, data=wpom3, listw=lw, control=list(pre_eig=e))
c(LM_test=signif(SLM_pre$LMtest), p.value=format.pval((1 - pchisq(SLM_pre$LMtest, 1))))
SLX_pre <- lmSLX(form_pre, data=wpom3, listw=lw)
OLS_pre <- lm(form_pre, data=wpom3)
```
```{r}
mlist_pre <- list(GNM=GNM_pre, SAC=SAC_pre, SDEM=SDEM_pre, SDM=SDM_pre, SLX=SLX_pre, SEM=SEM_pre, SLM=SLM_pre, OLS=OLS_pre)
m <- length(mlist_pre)
LR_pre <- matrix(NA, ncol=m, nrow=m)
colnames(LR_pre) <- rownames(LR_pre) <- names(mlist_pre)
for (j in 2:m) LR_pre[1, j] <- lrtest(mlist_pre[[1]],
    mlist_pre[[j]])[[2, "Pr(>Chisq)"]]
for (j in 6:8) LR_pre[2, j] <- lrtest(mlist_pre[[2]],
    mlist_pre[[j]])[[2, "Pr(>Chisq)"]]
for (j in c(5, 6, 8)) LR_pre[3, j] <- lrtest(mlist_pre[[3]],
    mlist_pre[[j]])[[2, "Pr(>Chisq)"]]
for (j in c(5:8)) LR_pre[4, j] <- lrtest(mlist_pre[[4]],
    mlist_pre[[j]])[[2, "Pr(>Chisq)"]]
for (i in 5:7) LR_pre[i, 8] <- lrtest(mlist_pre[[i]],
    mlist_pre[[8]])[[2, "Pr(>Chisq)"]]
```
```{r}
#| label: LR3_pre
#| fig-cap: Heat map of likelihood ratio p-values, pre_CCT models
opar <- par(mar=c(3.1, 3.1, 3.1, 7.1), cex.axis=0.8)
plot(LR_pre, breaks=c(0, 10^-(8:0)), col=viridis, las=1)
par(opar)
```
```{r}
sort(sapply(mlist_pre, AIC))
sort(sapply(mlist_pre, BIC))
```
```{r}
SEM_post <- errorsarlm(form_pre, data=wpom3, listw=lw, control=list(pre_eig=e))
Hausman.test(SEM_post)
```
```{r}
GNM_post <- sacsarlm(form_pre, data=wpom3, listw=lw,control=list(pre_eig1=e, pre_eig2=e))
SAC_post <- sacsarlm(form_pre, data=wpom3, listw=lw, control=list(pre_eig1=e, pre_eig2=e))
SDEM_post <- errorsarlm(form_pre, data=wpom3, listw=lw, control=list(pre_eig=e))
Hausman.test(SDEM_post)
```
```{r}
SDM_post <- lagsarlm(form_pre, data=wpom3, listw=lw, control=list(pre_eig=e))

c(LM_test=signif(SDM_post$LMtest), p.value=format.pval((1 - pchisq(SDM_post$LMtest, 1))))

SLM_post <- lagsarlm(form_pre, data=wpom3, listw=lw, control=list(pre_eig=e))

c(LM_test=signif(SLM_post$LMtest), p.value=format.pval((1 - pchisq(SLM_post$LMtest, 1))))

SLX_post <- lmSLX(form_pre, data=wpom3, listw=lw)

OLS_post <- lm(form_pre, data=wpom3)
```
```{r}
mlist_post <- list(GNM=GNM_post, SAC=SAC_post, SDEM=SDEM_post, SDM=SDM_post, SLX=SLX_post, SEM=SEM_post, SLM=SLM_post, OLS=OLS_post)
m <- length(mlist_post)
LR_post <- matrix(NA, ncol=m, nrow=m)
colnames(LR_post) <- rownames(LR_post) <- names(mlist_post)
for (j in 2:m) LR_post[1, j] <- lrtest(mlist_post[[1]],
    mlist_post[[j]])[[2, "Pr(>Chisq)"]]
for (j in 6:8) LR_post[2, j] <- lrtest(mlist_post[[2]],
    mlist_post[[j]])[[2, "Pr(>Chisq)"]]
for (j in c(5, 6, 8)) LR_post[3, j] <- lrtest(mlist_post[[3]],
    mlist_post[[j]])[[2, "Pr(>Chisq)"]]
for (j in c(5:8)) LR_post[4, j] <- lrtest(mlist_post[[4]],
    mlist_post[[j]])[[2, "Pr(>Chisq)"]]
for (i in 5:7) LR_post[i, 8] <- lrtest(mlist_post[[i]],
    mlist_post[[8]])[[2, "Pr(>Chisq)"]]
```
```{r}
#| label: LR3_post
#| fig-cap: Heat map of likelihood ratio p-values, post_CCT models
opar <- par(mar=c(3.1, 3.1, 3.1, 7.1), cex.axis=0.8)
plot(LR_post, breaks=c(0, 10^-(8:0)), col=viridis, las=1)
par(opar)

sort(sapply(mlist_post, AIC))

sort(sapply(mlist_post, BIC))
```




## Spatial econometrics models

```{r}
library(lmtest)
library(zoo)
```

```{r}
SDEM_pre <- errorsarlm(form_pre, data=wpom3, listw=lw, control=list(pre_eig=e))
```

```{r}
OLS_pre <- lm(form_pre, data=wpom3)
```



