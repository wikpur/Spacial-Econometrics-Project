---
title: ""
date: "`r Sys.Date()`"
output:
  rmdformats::downcute:
    self_contained: true
    default_style: "light"
    downcute_theme: "default"
---

```{r setup, include=FALSE}
## Global options
knitr::opts_chunk$set(cache = TRUE)
```


# *Spatial Trends in Property Crimes: A Focus on crimes against property across Poland's  Pomeranian voivodeship*

## INTRODUCTION

The study aims to analyze spatial trends in property crimes, in Poland in regards to the Pomeranian voivodeship and itâ€™s counties. Further examination explores how socio-economic factors---like unemployment rate, social services, average gross monthly salary, population density and international migrations --- affect crime rates, considering geographic contexts. The study takes data from 2018.

## I. DATA DESCRIPTION

The database comprises data on the number of ascertained crimes in 2018 across Poland's Pomeranian voivodeship and it's counties.

**Crime ascertained** is a crime concluded with confirmation of the occurrence of the prohibited act.

The database contain only the crimes committed by an adult.

[Note:]{.underline} Polish law indicates that theft with a value not exceeding 500 PLN is considered a misdemeanor, not a crime. Reporting such theft will not be considered or processed, so there is no point in reporting them. Such a situation causes a disturbance between the actual amount of thefts and the recorded ones, since people has no incentive to report a theft under 500 PLN. This aspect was taken into consideration during the examination.

## II. DATA VISUALIZATION

```{r}
install.packages(sf)
install.packages(rgugik)
install.packages(bdl)
install.packages(elevatr)
install.packages(terra)
install.packages("ggplot2")
install.packages("tidyverse")

```

```{r}
Sys.setenv("PROJ_NETWORK"="ON")
library(rgugik)
library(sf)
library(bdl)
```

### UNEMPLOYMENT RATE

We assume that there is direct proportional relationship between unemployment rate and crimes against propertyt (the higher rate of unemployment, the higher amount of crimes against property).

```{r}
Sys.setenv("PROJ_NETWORK"="ON")
library(rgugik)
library(sf)
substring(county_names$TERYT, 1, 2) -> vpom
county_names |> subset(subset = vpom == "22") -> pom0
```

```{r}
borders_get(TERYT = pom0$TERYT) -> pom
ID <- as.integer("0012345") 
str(ID)
formatC(ID, format="d", width=7, flag="0")
dim(pom)
pom |> sapply(class) |> str()
str(pom$TERYT)
str(pom0)
```
```{r}
pom$TERYT <- sub("_", "", pom$TERYT)
any(is.na(match(pom$TERYT, pom0$TERYT)))


## ----pl_m3, size="footnotesize"-----------------------------------------------
pom |> merge(pom0, by = "TERYT") -> pom1 
pom1
```
```{r}
unemp <- readxl::read_excel("Bezrobocie.xlsx")
sapply(unemp, class)
names(unemp)
pom1 |> merge(unemp, by.x = "TERYT",
 by.y = "Kod") -> pom2
pom2
```

```{r}
library(mapview)
mapview(pom2, zcol="Unemployment")
```

```{r}
install.packages("giscoR")
library(giscoR)
pom_gisco <- gisco_get_nuts(year="2021", resolution="01",
 spatialtype="RG", nuts_id="PL63")
pom_gisco_tm <- st_transform(pom_gisco, "EPSG:2180")
pom3 <- st_intersection(pom2, pom_gisco_tm)
```

```{r}
pom2 |> st_geometry_type() |> table() -> tab5; tab5[tab5>0]
```


```{r}
pom3 |> st_geometry_type() |> table() -> tab6; tab6[tab6>0]
```


```{r}
pom3 |> st_cast("MULTIPOLYGON") -> pom3
```

```{r}
mapview(pom3, zcol="Unemployment")
```

```{r}
plot(density(pom3$Unemployment))
```

```{r}
install.packages("mapsf")
library(mapsf)
mapsf::mf_map(pom3, var="Unemployment", type="choro", breaks="geom",
 nbreaks=7)
```

### SOCIAL SERVICES USERS

A direct proportional relationship between social services users and crimes against property is assumed (the higher rate of social services users, the higher amount of crimes against property).

```{r}
Sys.setenv("PROJ_NETWORK"="ON")
library(rgugik)
library(sf)
substring(county_names$TERYT, 1, 2) -> vpom1
county_names |> subset(subset = vpom1 == "22") -> pom00
```

```{r}
borders_get(TERYT = pom00$TERYT) -> pom4
ID <- as.integer("0012345") 
str(ID)
formatC(ID, format="d", width=7, flag="0")
dim(pom4)
pom4 |> sapply(class) |> str()
str(pom4$TERYT)
str(pom00)
```
```{r}
pom4$TERYT <- sub("_", "", pom4$TERYT)
any(is.na(match(pom4$TERYT, pom00$TERYT)))


## ----pl_m3, size="footnotesize"-----------------------------------------------
pom4 |> merge(pom00, by = "TERYT") -> pom5 
pom5
```



```{r}
ssusers <- readxl::read_excel("social_services_users.xlsx")
sapply(ssusers, class)
names(ssusers)
pom5 |> merge(ssusers, by.x = "TERYT",
 by.y = "Code") -> pom6
pom6
```
```{r}
library(mapview)
mapview(pom6, zcol="social_services_users")
```

```{r}
pom_gisco1 <- gisco_get_nuts(year="2021", resolution="01",
 spatialtype="RG", nuts_id="PL63")
pom_gisco_tm1 <- st_transform(pom_gisco1, "EPSG:2180")
pom7 <- st_intersection(pom6, pom_gisco_tm1)
```
```{r}
pom6 |> st_geometry_type() |> table() -> tab5; tab5[tab5>0]
```

```{r}
pom7 |> st_geometry_type() |> table() -> tab6; tab6[tab6>0]
```

```{r}
pom7 |> st_cast("MULTIPOLYGON") -> pom7
```

```{r}
mapview(pom7, zcol="social_services_users")
```

```{r}
plot(density(pom7$social_services_users))
```

```{r}
mapsf::mf_map(pom7, var="social_services_users", type="choro", breaks="geom",
 nbreaks=7)
```
### III. TO BE CONTINUED!!!!

### AVERAGE GROSS MONTHLY SALARY 

An inverse relationship between average gross monthly salary and crimes against property is assumed (the higher amount of average gross monthly salary, the lower amount of crimes against property).

```{r}
Sys.setenv("PROJ_NETWORK"="ON")
substring(county_names$TERYT, 1, 2) -> vpom2
county_names |> subset(subset = vpom2 == "22") -> pom000
```

```{r}
borders_get(TERYT = pom000$TERYT) -> pom8
ID <- as.integer("0012345") 
str(ID)
formatC(ID, format="d", width=7, flag="0")
dim(pom8)
pom8 |> sapply(class) |> str()
str(pom8$TERYT)
str(pom000)
```

```{r}
pom8$TERYT <- sub("_", "", pom8$TERYT)
any(is.na(match(pom8$TERYT, pom000$TERYT)))


## ----pl_m3, size="footnotesize"-----------------------------------------------
pom8 |> merge(pom000, by = "TERYT") -> pom9 
pom9
```


```{r}
avgsal <- readxl::read_excel("monthly_average_salary.xlsx")
sapply(avgsal, class)
names(avgsal)
pom9 |> merge(avgsal, by.x = "TERYT",
              by.y = "Code") -> pom10
pom10
```

```{r}
library(mapview)
mapview(pom10, zcol="Average_Monthly_Gross_Wages_and_Salaries")
```

```{r}
pom_gisco2 <- gisco_get_nuts(year="2021", resolution="01",
                             spatialtype="RG", nuts_id="PL63")
pom_gisco_tm2 <- st_transform(pom_gisco2, "EPSG:2180")
pom11 <- st_intersection(pom10, pom_gisco_tm2)
```

```{r}
pom10 |> st_geometry_type() |> table() -> tab5; tab5[tab5>0]
```


```{r}
pom11 |> st_geometry_type() |> table() -> tab6; tab6[tab6>0]
```

```{r}
pom11 |> st_cast("MULTIPOLYGON") -> pom11
```

```{r}
mapview(pom11, zcol="Average_Monthly_Gross_Wages_and_Salaries")
```

```{r}
plot(density(pom11$Average_Monthly_Gross_Wages_and_Salaries))
```

```{r}
mapsf::mf_map(pom11, var="Average_Monthly_Gross_Wages_and_Salaries", type="choro", breaks="geom",
              nbreaks=7)
```

### POPULATION DENSITY 

It is assumed that the number of crimes committed is directly proportional to the population density of cities, meaning we expect a greater number of thefts in larger urban areas.

```{r}
substring(county_names$TERYT, 1, 2) -> vpom3
county_names |> subset(subset = vpom3 == "22") -> pom0000
```

```{r}
borders_get(TERYT = pom0000$TERYT) -> pom12
ID <- as.integer("0012345") 
str(ID)
formatC(ID, format="d", width=7, flag="0")
dim(pom12)
pom12 |> sapply(class) |> str()
str(pom12$TERYT)
str(pom0000)
```

```{r}
pom12$TERYT <- sub("_", "", pom12$TERYT)
any(is.na(match(pom12$TERYT, pom0000$TERYT)))


## ----pl_m3, size="footnotesize"-----------------------------------------------
pom12 |> merge(pom0000, by = "TERYT") -> pom13 
pom13
```

```{r}
popdens <- readxl::read_excel("population_density.xlsx")
sapply(popdens, class)
names(popdens)
pom13 |> merge(popdens, by.x = "TERYT",
               by.y = "Code") -> pom14
pom14
```

```{r}
mapview(pom14, zcol="Population Density")
```

```{r}
pom_gisco3 <- gisco_get_nuts(year="2021", resolution="01",
                             spatialtype="RG", nuts_id="PL63")
pom_gisco_tm3 <- st_transform(pom_gisco3, "EPSG:2180")
pom15 <- st_intersection(pom14, pom_gisco_tm3)
```

```{r}
pom14 |> st_geometry_type() |> table() -> tab5; tab5[tab5>0]
```


```{r}
pom15 |> st_geometry_type() |> table() -> tab6; tab6[tab6>0]
```

```{r}
pom15 |> st_cast("MULTIPOLYGON") -> pom15
pom15
```

```{r}
mapview(pom15, zcol="Population.Density")
```

```{r}
plot(density(pom15$Population.Density))
```

```{r}
mapsf::mf_map(pom15, var="Population.Density", type="choro", breaks="geom",
              nbreaks=7)
```

### CRIMES

```{r}
substring(county_names$TERYT, 1, 2) -> vpom4
county_names |> subset(subset = vpom4 == "22") -> pom00000
```

```{r}
borders_get(TERYT = pom00000$TERYT) -> pom16
ID <- as.integer("0012345") 
str(ID)
formatC(ID, format="d", width=7, flag="0")
dim(pom16)
pom16 |> sapply(class) |> str()
str(pom16$TERYT)
str(pom00000)
```

```{r}
pom16$TERYT <- sub("_", "", pom16$TERYT)
any(is.na(match(pom16$TERYT, pom00000$TERYT)))


## ----pl_m3, size="footnotesize"-----------------------------------------------
pom16 |> merge(pom00000, by = "TERYT") -> pom17
pom17
```

```{r}
crimes <- readxl::read_excel("crimes.xlsx")
sapply(crimes, class)
names(crimes)
pom17 |> merge(crimes, by.x = "TERYT",
 by.y = "Code") -> pom18
pom18
```

```{r}
mapview(pom18, zcol="Crimes")
```

```{r}
pom_gisco4 <- gisco_get_nuts(year="2021", resolution="01",
 spatialtype="RG", nuts_id="PL63")
pom_gisco_tm4 <- st_transform(pom_gisco4, "EPSG:2180")
pom19 <- st_intersection(pom18, pom_gisco_tm4)
```

```{r}
pom18 |> st_geometry_type() |> table() -> tab5; tab5[tab5>0]
```

```{r}
pom19 |> st_geometry_type() |> table() -> tab6; tab6[tab6>0]
```


```{r}
pom19 |> st_cast("MULTIPOLYGON") -> pom19
```

```{r}
mapview(pom19, zcol="Crimes")
```

```{r}
plot(density(pom19$Crimes))
```

```{r}
mapsf::mf_map(pom19, var="Crimes", type="choro", breaks="geom",
 nbreaks=7)
```

```{r}
library(sf)
install.packages("spdep")
library(spdep)
```

```{r}
(pom1 |> poly2nb(queen=FALSE,
 row.names=pom1$TERYT) -> pom_rook_nb)
```

```{r}
(pom1 |> poly2nb(queen=TRUE,
 row.names=pom1$TERYT) -> pom_queen_nb)
```

```{r}
(pom1 |> poly2nb(queen=FALSE, row.names=pom1$TERYT,
 snap=0.00001) -> pom_rook_nb)
(pom1 |> poly2nb(queen=TRUE, row.names=pom1$TERYT,
 snap=0.00001) -> pom_queen_nb)
```

```{r}
geom <- st_geometry(pom1) 
plot(geom, border="grey")
plot(pom_queen_nb, geom, add=TRUE)
```
```{r}
(geom |> st_point_on_surface() |> knearneigh(k=5) |>
 knn2nb(row.names=pom1$TERYT) -> pom_1_nb)
```

```{r}
plot(geom, border="grey")
plot(pom_1_nb, geom, add=TRUE)
```



